<script type="text/javascript">var ha={nodeColors:{action:"#46B1EF",alpha:"#E78BB9",api:"#7CDFFD",beta:"#77DD77",data:"#5BCBF7",event:"#399CDF"}};</script>
<script type="text/javascript">var exposeNode=function(e){let t;function n(){const t=e("#node-input-server").val();if(t&&"_ADD_"!==t)return t}function o(){if(!e("#integrationAlert").length){const t='<div id="integrationAlert" class="ui-state-error ha-alert-box"><strong>Attention:</strong> This node requires <a href="https://github.com/zachowj/hass-node-red" target="_blank">Node-RED custom integration <i class="fa fa-external-link external-link"></i></a> to be installed in Home Assistant for it to function.</strong></div>';e("#dialog-form").prepend(t)}e("#integrationAlert").toggle(0===t.integrationVersion)}function i(){0===t.integrationVersion&&e("#node-input-exposeToHomeAssistant").prop("checked",!1).trigger("change"),e("#exposeToHa").toggle(0!==t.integrationVersion)}return{init:function(a){t=a,function(){switch(t.type){case"ha-webhook":case"ha-entity":o();break;default:!function(){const n=e("<div />",{id:"exposeToHa",class:"form-row checkbox-option"+("trigger-state"===t.type?"-left":"")});e("<input />",{type:"checkbox",id:"node-input-exposeToHomeAssistant",checked:t.exposeToHomeAssistant}).on("change",(function(){e("#haConfigRow").toggle(!0===e("#node-input-exposeToHomeAssistant").is(":checked"))})).appendTo(n),e("<label />",{for:"node-input-exposeToHomeAssistant",text:"Expose to Home Assistant"}).appendTo(n);const o=e("<div />",{class:"form-row",id:"haConfigRow"}),i=e("<ol />",{id:"haConfig"}).appendTo(o),a=t.haConfig||[{property:"name",value:""},{property:"icon",value:""}];i.editableList({addButton:!1,header:e("<div>Home Assistant Config (optional)</div>"),addItem:function(t,n,o){const i=e("<div />").appendTo(t);e("<input />",{type:"text",name:"property",value:o.property,style:"width: 40%;",readonly:!0}).appendTo(i),e("<input />",{type:"text",name:"value",value:o.value,style:"margin-left: 10px;width: 55%;"}).attr("autocomplete","disable").appendTo(i)}}).editableList("addItems",a),e("#dialog-form").append(n).append(o),e("#node-input-exposeToHomeAssistant").trigger("change")}()}}();const s=function(){switch(t.type){case"ha-webhook":case"ha-entity":return o;default:return i}}();e("#node-input-server").on("change",(()=>function(o){n()?e.getJSON(`homeassistant/${n()}/version?_=${Date.now()}`).done((e=>{t.integrationVersion=e.version,o&&o(t)})):o(t)}(s)))},getValues:function(){const t=[];return e("#haConfig").editableList("items").each((function(n){const o=e(this);t.push({property:o.find("input[name=property]").val(),value:o.find("input[name=value]").val()})})),t}}}(jQuery);</script>
<script type="text/javascript">var haServer=function(e,n){let o,t,r;function a(r,a){"_ADD_"!==t&&e.getJSON(`homeassistant/${t}/${r}`).done((e=>{a(e)})).fail((e=>{const t=n.nodes.node(o.val());t&&!0===t.dirty&&n.notify(`You probably haven't deployed since adding a server. Do that for autocomplete to work.\n${e.responseText}`,"error")}))}return{init:function(t,a){o=e(a),r=t,r.server||function(){let e;n.nodes.eachConfig((n=>{"server"!==n.type||e||(e=n.id)})),e&&o.val(e)}()},autocomplete:function(e,n){const i=o.val();(r.server||i&&"_ADD_"!==i)&&(t=r.server||i,a(e,n)),o.change((()=>{t=o.val(),a(e,n)}))}}}(jQuery,RED);</script>
<script type="text/javascript">var ifState=function(e){let t;return{init:function(a,n,s){t=e(a);const c=e(n),l={value:"entity",label:"entity."},r=["str","num","bool","re","jsonata","msg","flow","global",l];"currentState"!==s&&r.splice(5,1),t.after(' <a id="clearIfState" class="editor-button"><i class="fa fa-remove"></i></a>');const o=e("#clearIfState");t.typedInput({default:"str",types:r,typeField:"#node-input-halt_if_type"}),c.on("change",(e=>{let a=r,n=["flow","global",l];switch(r.includes("msg")&&(n=["msg",...n]),e.target.value){case"is":case"is_not":break;case"lt":case"lte":case"gt":case"gte":a=["num","jsonata",...n];break;case"includes":case"does_not_include":a=["str","jsonata",...n];break;case"jsonata":a=["jsonata"]}t.typedInput("types",a)})),c.trigger("change"),t.on("change",(e=>{e.currentTarget.value&&o.show()})),o.on("click",(a=>{t.typedInput("type","str"),t.typedInput("value",""),e(a.currentTarget).hide()})),t.val()||o.hide()}}}(jQuery);</script>
<script type="text/javascript">var nodeVersion=function(e){return{check:function(t){t.version=void 0===t.version?0:Number(t.version);const r=`<div id="version-update" class="ui-state-error ha-alert-box"><p><strong>Alert:</strong>This node will be updated to version ${t._def.defaults.version.value} from ${t.version} (<a href="${function(e){let t="";switch(e){case"api-current-state":t="current-state";break;case"api-call-service":t="call-service";break;case"poll-state":t="poll-state";break;case"server-state-changed":t="events-state"}return`https://zachowj.github.io/node-red-contrib-home-assistant-websocket/node/${t}.html#changelog`}(t.type)}#version" target="_blank" rel="noreferrer">changes</a>)</p></div>`;t.version<t._def.defaults.version.value&&e("#dialog-form").prepend(r)},ifStateLabels:function(e){if(this.halt_if||this.haltifstate){if(0===Number(this.version)||void 0===this.version){if(0===e)return"'If State' is false";if(1===e)return"'If State' is true"}if(0===e)return"'If State' is true";if(1===e)return"'If State' is false"}},labelStyle:function(){return`${this._def.defaults.version&&Number(this.version)!==this._def.defaults.version.value?"ha-node-label-legacy ":""}${this.name?"node_label_italic":""}`},update:function(t){t.version<t._def.defaults.version.value&&e("#node-input-version").val(t._def.defaults.version.value)}}}(jQuery);</script>
<script type="text/javascript">RED.nodes.registerType("trigger-state",{category:"home_assistant",color:"#399CDF",inputs:1,outputs:2,outputLabels:function(e){if(0===e)return"allowed";if(1===e)return"blocked";const t=this.customoutputs[e-2];let a;return a="always"===t.comparatorPropertyType?"always sent":`${t.comparatorPropertyType.replace("_"," ")} ${t.comparatorType.replace("_","")} ${t.comparatorValue}`,a},icon:"font-awesome/fa-map-signs",paletteLabel:"trigger: state",label:function(){return this.name||`trigger-state: ${this.entityid}`},labelStyle:nodeVersion.labelStyle,defaults:{name:{value:""},server:{value:"",type:"server",required:!0},exposeToHomeAssistant:{value:!1},haConfig:{value:[{property:"name",value:""},{property:"icon",value:""}]},entityid:{value:"",required:!0},entityidfiltertype:{value:"exact"},debugenabled:{value:!1},constraints:{value:[{targetType:"this_entity",targetValue:"",propertyType:"current_state",propertyValue:"new_state.state",comparatorType:"is",comparatorValueDatatype:"str",comparatorValue:""}]},outputs:{value:2},customoutputs:{value:[]},outputinitially:{value:!1},state_type:{value:"str"}},oneditprepare:function(){const e=$("#constraint-list"),t=$("#output-list");let a=[],r=[],o=[];haServer.init(this,"#node-input-server"),haServer.autocomplete("entities",(e=>{a=e,$("#node-input-entityid").autocomplete({source:e,minLength:0})})),haServer.autocomplete("properties",(e=>{r=e,o=[...e.map((e=>`new_state.${e}`)),...e.map((e=>`old_state.${e}`))].sort()})),exposeNode.init(this);const p=$("#node-input-outputs").val('{"0": 0, "1": 1}'),n=()=>JSON.parse(p.val()),s=e=>{p.val(JSON.stringify(e))},i=e=>{t.editableList("items").each((function(t){const a=$(this).data("data");e[Object.prototype.hasOwnProperty.call(a,"index")?a.index:a._index]=t+2}))};e.on("change",".target-type",(function(){const e=$(this),t="this_entity"===e.val(),a=e.parent().parent(),r=e.next(),o=a.find(".property-type");t?r.attr("disabled","disabled").val(""):r.removeAttr("disabled"),o.find("option[value=previous_state]").toggle(t),"previous_state"===o.val()&&o.val("current_state").trigger("change")})),e.on("change",".property-type",(function(e){const t=e.target.value;"current_state"===t||"previous_state"===t?$(this).next().attr("disabled","disabled").val(""):$(this).next().removeAttr("disabled")})),t.on("change",".comparator-property-type",(function(e){const t=e.target.value,a=$(this).parent().parent(),r=a.find(".comparator-type"),o=a.find(".comparator-value"),p=a.find(".comparator-property-value");switch(t){case"always":p.attr("disabled","disabled"),r.attr("disabled","disabled"),o.attr("disabled","disabled"),p.val("");break;case"previous_state":case"current_state":p.attr("disabled","disabled"),r.removeAttr("disabled"),o.removeAttr("disabled"),p.val("");break;case"property":p.removeAttr("disabled"),r.removeAttr("disabled"),o.removeAttr("disabled")}}));e.editableList({addButton:!0,removable:!0,height:"auto",header:$("<div>").append("Conditions"),addItem:(e,t,p)=>{$("#constraint-template").children().clone().appendTo(e),e.find(".target-value").autocomplete({source:(e,t)=>{const r=e.term.toLowerCase();t(a.filter((e=>e.includes(r))))},minLength:0}),e.find(".property-value").autocomplete({source:(t,a)=>{const p=t.term.toLowerCase();a(("this_entity"===e.find(".target-type").val()?o:r).filter((e=>e.includes(p))))},minLength:0}),e.find(".comparator-value").typedInput({default:"str",types:["str","num","bool","re","jsonata",{value:"entity",label:"entity."},{value:"prevEntity",label:"prev entity."}]}),$.isEmptyObject(p)||(e.find(".target-type").val(p.targetType).trigger("change"),e.find(".target-value").val(p.targetValue),e.find(".property-type").val(p.propertyType).trigger("change"),"property"===p.propertyType&&e.find(".property-value").val(p.propertyValue),e.find(".comparator-type").val(p.comparatorType),e.find(".comparator-value").typedInput("type",p.comparatorValueDatatype).typedInput("value",p.comparatorValue))}}),e.editableList("addItems",this.constraints.length?this.constraints:{}),t.on("change",".message-type",(function(e){const t=e.target.value;$(this).parent().find(".message-value").typedInput("default"===t?"hide":"show")})),t.on("change",".comparator-property-type",(function(e){const t=e.target.value,a=$(this).parent().parent(),r=a.find(".comparator-property-value"),o=a.find(".comparator-type"),p=a.find(".comparator-value");switch(t){case"always":r.attr("disabled","disabled"),o.attr("disabled","disabled"),p.typedInput("hide"),r.val("");break;case"previous_state":case"current_state":r.attr("disabled","disabled"),o.removeAttr("disabled"),p.typedInput("show"),r.val("");break;case"property":r.removeAttr("disabled"),o.removeAttr("disabled"),p.typedInput("show")}})),t.editableList({addButton:!0,removable:!0,sortable:!0,height:"auto",header:$("<div>").append("Custom outputs"),addItem:function(e,t,a){Object.prototype.hasOwnProperty.call(a,"condition")||(a.condition={});const r=a.condition;Object.prototype.hasOwnProperty.call(a,"index")||(a._index=Math.floor(563609*Math.random()).toString()),$("#output-template").children().clone().appendTo(e),e.css({overflow:"hidden",whiteSpace:"nowrap"}),e.find(".message-value").typedInput({default:"json",types:["str","num","bool","json"]}),e.find(".comparator-property-value").autocomplete({source:(e,t)=>{const a=e.term.toLowerCase();t(o.filter((e=>e.includes(a))))},minLength:0}),e.find(".comparator-value").typedInput({default:"str",types:["str","num","bool","re","jsonata",{value:"entity",label:"entity."},{value:"prevEntity",label:"prev entity."}]});const p=n();p[Object.prototype.hasOwnProperty.call(a,"index")?a.index:a._index]=t+2,s(p),$.isEmptyObject(r)?e.find(".message-type,.comparator-property-type").trigger("change"):(e.find(".message-type").val(r.messageType).trigger("change"),e.find(".message-value").typedInput("value",r.messageValue).typedInput("type",r.messageValueType),e.find(".comparator-property-type").val(r.comparatorPropertyType).trigger("change"),"property"===r.comparatorPropertyType&&e.find(".comparator-property-value").val(r.comparatorPropertyValue),e.find(".comparator-type").val(r.comparatorType),e.find(".comparator-value").typedInput("value",r.comparatorValue).typedInput("type",r.comparatorValueDataType))},removeItem:function(e){const t=n();Object.prototype.hasOwnProperty.call(e,"index")?t[e.index]=-1:delete t[e._index],i(t),s(t)},sortItems:function(){const e=n();i(e),s(e)}}),this.customoutputs.forEach(((e,a)=>t.editableList("addItem",{condition:e,index:a+2})))},oneditsave:function(){const e=$("#constraint-list").editableList("items"),t=$("#output-list").editableList("items"),a=[],r=[];e.each((function(){const e=$(this),t=e.find(".comparator-value"),r={targetType:e.find(".target-type").val(),targetValue:e.find(".target-value").val(),propertyType:e.find(".property-type").val(),comparatorType:e.find(".comparator-type").val(),comparatorValueDatatype:t.typedInput("type"),comparatorValue:t.typedInput("value")};"current_state"===r.propertyType?r.propertyValue="new_state.state":"previous_state"===r.propertyType?r.propertyValue="old_state.state":r.propertyValue=e.find(".property-value").val(),"includes"!==r.comparatorType&&"does_not_include"!==r.comparatorType||(r.comparatorValueDatatype="list"),a.push(r)})),t.each((function(){const e=$(this),t=e.find(".message-value"),a=e.find(".comparator-value"),o={messageType:e.find(".message-type").val(),messageValue:t.typedInput("value"),messageValueType:t.typedInput("type"),comparatorPropertyType:e.find(".comparator-property-type").val(),comparatorType:e.find(".comparator-type").val(),comparatorValue:a.typedInput("value"),comparatorValueDataType:a.typedInput("type")};"current_state"===o.comparatorPropertyType?o.comparatorPropertyValue="new_state.state":"previous_state"===o.comparatorPropertyType?o.comparatorPropertyValue="old_state.state":o.comparatorPropertyValue=e.find(".comparator-property-value").val(),"includes"!==o.comparatorType&&"does_not_include"!==o.comparatorType||(o.comparatorValueDataType="list"),r.push(o)})),this.constraints=a,this.customoutputs=r,this.haConfig=exposeNode.getValues()}});</script>
<script type="text/x-red" data-template-name="trigger-state"><!-- Name --><div class="form-row"><label for="node-input-name"><i class="fa fa-tag"></i> Name</label> <input type="text" id="node-input-name" placeholder="Name"> <input type="hidden" id="node-input-outputs"></div><!-- Server --><div class="form-row"><label for="node-input-server"><i class="fa fa-server"></i> Server</label> <input type="text" id="node-input-server"></div><!-- Entity ID Filter and Filter Type --><div class="form-row"><label for="node-input-entityid"><i class="fa fa-tag"></i> Entity ID</label> <input type="text" id="node-input-entityid" style="width:50%"> <select type="text" id="node-input-entityidfiltertype" style="width:20%"><option value="exact">Exact</option><option value="substring">Substring</option><option value="regex">Regex</option></select></div><div class="form-row"><label for="node-input-state_type"><i class="fa fa-tint"></i> State Type</label> <select type="text" id="node-input-state_type" style="width:auto"><option value="str">String</option><option value="num">Number</option><option value="habool">Boolean</option></select></div><!-- Constraints List --><div class="form-row"><ol id="constraint-list"></ol></div><!-- Output List --><div class="form-row"><ol id="output-list"></ol></div><div class="form-row checkbox-option-left"><input type="checkbox" id="node-input-outputinitially"> <label for="node-input-outputinitially">Output on Connect</label></div><div class="form-row checkbox-option-left"><input type="checkbox" id="node-input-debugenabled"> <label for="node-input-debugenabled">Show Debug Information</label></div><div id="constraint-template" style="display:none"><!-- Target Selection --><div class="editable-list-row"><!-- Type --> <select type="text" class="target-type" style="width:140px"><option value="this_entity">This Entity</option><option value="entity_id">Entity ID</option></select><!-- Value --> <input type="text" class="target-value" disabled="disabled"></div><!-- Property Selection --><div class="editable-list-row"><!-- Type --> <select type="text" class="property-type" style="width:140px"><option value="current_state">Current State</option><option value="previous_state">Previous State</option><option value="property">Property</option></select><!-- Value --> <input type="text" class="property-value" disabled="disabled"></div><!-- Comparator Selection --><div class="editable-list-row"><!-- Type --> <select type="text" class="comparator-type" style="width:140px"><option value="is">is</option><option value="is_not">is not</option><option value=">">&gt;</option><option value=">=">&gt;=</option><option value="<">&lt;</option><option value="<=">&lt;=</option><option value="includes">in</option><option value="does_not_include">not in</option></select><!-- Value --> <input type="text" class="comparator-value" style="width:65%"></div></div><div id="output-template" style="display:none"><div class="editable-list-row"><!-- Type --> <select type="text" class="message-type" style="width:140px"><option value="default">Default Msg</option><option value="custom">Custom Msg</option><option value="payload">Custom Payload</option></select> <input type="text" class="message-value" style="width:62%"></div><!-- Output Comparator Selection --><div class="editable-list-row"><select type="text" class="comparator-property-type" style="width:140px"><option value="always">Send Always</option><option value="current_state">If State</option><option value="previous_state">If Prev State</option><option value="property">If Property</option></select> <input type="text" class="comparator-property-value" disabled="disabled"></div><div class="editable-list-row"><!-- Type --> <select type="text" class="comparator-type" style="width:140px" disabled="disabled"><option value="is">is</option><option value="is_not">is not</option><option value=">">&gt;</option><option value=">=">&gt;=</option><option value="<">&lt;</option><option value="<=">&lt;=</option><option value="includes">in</option><option value="does_not_include">not in</option></select> <input type="text" class="comparator-value" style="width:62%"></div></div></script>
<script type="text/x-red" data-help-name="trigger-state"><p>Much like the <code>State Changed Node</code> however, provides some advanced functionality around common automation use cases.</p><p>An advanced version of <code>server:state-changed</code> node</p><!-- TODO: Needs a total rework --><h3>Configuration</h3><dl class="message-properties"><dt>Conditions<span class="property-type"></span></dt><dd>This node has two default outputs &quot;allowed&quot; and &quot;blocked&quot;. If all the conditions are true the default message will be sent to the &quot;allowed&quot; output otherwise it will be sent to the &quot;blocked&quot; output.</dd><dd><strong>See Also:</strong></dd><ul><li><a href="https://zachowj.github.io/node-red-contrib-home-assistant-websocket/guide/conditionals.html" rel="noopener noreferrer">Conditionals</a></li></ul><dt>Custom Outputs<span class="property-type"></span></dt><dd>All the above conditions need to be true for any custom outputs to be sent, having zero conditions is a valid option. Each custom output can send the default message or a custom message. Also, each one can have its constraint on whether or not to be sent.</dd></dl><h3>Input</h3><dl class="message-properties"><dt>Enable / Disable<span class="property-type">string</span></dt><dd>If incoming payload or message is a string and equal to <code>enable</code> or <code>disable</code> then set the node accordingly. Saves over restarts.</dd><dt>Output Initially<span class="property-type">boolean</span></dt><dd>Output once on startup/deploy.</dd></dl><h3>Output</h3><dl class="message-properties"><dt>topic<span class="property-type">string</span></dt><dd>The entity_id that triggered the node</dd><dt>payload<span class="property-type">string</span></dt><dd>The state as sent by home assistant</dd><dt>data<span class="property-type">object</span></dt><dd>The original home assistant event containing <code>entity_id</code> <code>new_state</code> and <code>old_state</code> properties</dd></dl><h3>Testing</h3><dl class="message-properties"><dd>To test automation without having to manually change state in-home assistant send an input <code>payload</code> as an object which contains <code>entity_id</code>, <code>new_state</code>, and <code>old_state</code> properties. This will trigger the node as if the event came from Home Assistant.</dd><pre><code class="language-json">{
  &quot;entity_id&quot;: &quot;test_entity&quot;,
  &quot;old_state&quot;: {
    &quot;state&quot;: &quot;on&quot;
  },
  &quot;new_state&quot;: {
    &quot;state&quot;: &quot;off&quot;
  }
}
</code></pre></dl><h3>References</h3><dl class="message-properties"><ul><li><a href="https://home-assistant.io/docs/configuration/state_object">HA State Object</a></li></ul></dl></script>
<style>#version-update{padding:.5em;margin-bottom:1em}#version-update p{margin:0}#version-update strong{padding-right:5px}#version-update a,#version-update a:hover{color:#555}.form-row.checkbox-option input{margin-left:105px;margin-right:5px;display:inline-block;width:auto;vertical-align:top}.form-row.checkbox-option label{width:auto}.form-row.checkbox-option-left input{display:inline-block;margin-right:5px;width:auto;vertical-align:top}.form-row.checkbox-option-left label{width:auto;margin-right:20px}.editable-list-row{margin-bottom:4px}#constraint-list{min-width:446px}#constraint-list input{width:65%}#output-list input{width:62%}#clearIfState{position:absolute;margin-left:2px}.ha-node-label-legacy{fill:#fdfd96;stroke-width:0;font-size:14px;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}li span.property-type{font-family:Helvetica Neue,Arial,Helvetica,sans-serif;color:#666;font-style:italic;font-size:11px;float:right}.ha-alert-box{padding:10px;margin-bottom:10px}.custom-block .custom-block-title{font-weight:600}.custom-block.danger,.custom-block.tip,.custom-block.warning{padding:.1rem 1.5rem;border-left-width:.5rem;border-left-style:solid;margin:1rem 0}.custom-block.tip{background-color:#f3f5f7;border-color:#42b983;color:#2c3e50}.custom-block.tip a{color:#3eaf7c}.custom-block.warning{background-color:#fff6c6;border-color:#e7c000;color:#6b5900}.custom-block.warning .custom-block-title{color:#b29400}.custom-block.warning a{color:#2c3e50}.custom-block.danger{background-color:#ffe6e6;border-color:#c00;color:#4d0000}.custom-block.danger .custom-block-title{color:#900}.custom-block.danger a{color:#2c3e50}.button-box div.text-box{display:inline-block;position:relative;width:70%;height:20px}.button-box div.text-box div{position:absolute;left:0;right:40px}.button-box div.text-box div input{width:100%}.button-box div.text-box a{position:absolute;right:0;top:0}.badge{display:inline-block;font-size:12px;height:16px;line-height:16px;border-radius:3px;padding:0 6px;color:#fff}.badge,.badge.green,.badge.tip{background-color:#42b983}.badge.error{background-color:#da5961}.badge.warn,.badge.warning,.badge.yellow{background-color:#e7c000}.badge+.badge{margin-left:5px}</style>
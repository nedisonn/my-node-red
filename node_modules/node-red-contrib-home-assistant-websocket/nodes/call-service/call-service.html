<script type="text/javascript">var ha={nodeColors:{action:"#46B1EF",alpha:"#E78BB9",api:"#7CDFFD",beta:"#77DD77",data:"#5BCBF7",event:"#399CDF"}};</script>
<script type="text/javascript">var exposeNode=function(e){let t;function n(){const t=e("#node-input-server").val();if(t&&"_ADD_"!==t)return t}function o(){if(!e("#integrationAlert").length){const t='<div id="integrationAlert" class="ui-state-error ha-alert-box"><strong>Attention:</strong> This node requires <a href="https://github.com/zachowj/hass-node-red" target="_blank">Node-RED custom integration <i class="fa fa-external-link external-link"></i></a> to be installed in Home Assistant for it to function.</strong></div>';e("#dialog-form").prepend(t)}e("#integrationAlert").toggle(0===t.integrationVersion)}function i(){0===t.integrationVersion&&e("#node-input-exposeToHomeAssistant").prop("checked",!1).trigger("change"),e("#exposeToHa").toggle(0!==t.integrationVersion)}return{init:function(a){t=a,function(){switch(t.type){case"ha-webhook":case"ha-entity":o();break;default:!function(){const n=e("<div />",{id:"exposeToHa",class:"form-row checkbox-option"+("trigger-state"===t.type?"-left":"")});e("<input />",{type:"checkbox",id:"node-input-exposeToHomeAssistant",checked:t.exposeToHomeAssistant}).on("change",(function(){e("#haConfigRow").toggle(!0===e("#node-input-exposeToHomeAssistant").is(":checked"))})).appendTo(n),e("<label />",{for:"node-input-exposeToHomeAssistant",text:"Expose to Home Assistant"}).appendTo(n);const o=e("<div />",{class:"form-row",id:"haConfigRow"}),i=e("<ol />",{id:"haConfig"}).appendTo(o),a=t.haConfig||[{property:"name",value:""},{property:"icon",value:""}];i.editableList({addButton:!1,header:e("<div>Home Assistant Config (optional)</div>"),addItem:function(t,n,o){const i=e("<div />").appendTo(t);e("<input />",{type:"text",name:"property",value:o.property,style:"width: 40%;",readonly:!0}).appendTo(i),e("<input />",{type:"text",name:"value",value:o.value,style:"margin-left: 10px;width: 55%;"}).attr("autocomplete","disable").appendTo(i)}}).editableList("addItems",a),e("#dialog-form").append(n).append(o),e("#node-input-exposeToHomeAssistant").trigger("change")}()}}();const s=function(){switch(t.type){case"ha-webhook":case"ha-entity":return o;default:return i}}();e("#node-input-server").on("change",(()=>function(o){n()?e.getJSON(`homeassistant/${n()}/version?_=${Date.now()}`).done((e=>{t.integrationVersion=e.version,o&&o(t)})):o(t)}(s)))},getValues:function(){const t=[];return e("#haConfig").editableList("items").each((function(n){const o=e(this);t.push({property:o.find("input[name=property]").val(),value:o.find("input[name=value]").val()})})),t}}}(jQuery);</script>
<script type="text/javascript">var haServer=function(e,n){let o,t,r;function a(r,a){"_ADD_"!==t&&e.getJSON(`homeassistant/${t}/${r}`).done((e=>{a(e)})).fail((e=>{const t=n.nodes.node(o.val());t&&!0===t.dirty&&n.notify(`You probably haven't deployed since adding a server. Do that for autocomplete to work.\n${e.responseText}`,"error")}))}return{init:function(t,a){o=e(a),r=t,r.server||function(){let e;n.nodes.eachConfig((n=>{"server"!==n.type||e||(e=n.id)})),e&&o.val(e)}()},autocomplete:function(e,n){const i=o.val();(r.server||i&&"_ADD_"!==i)&&(t=r.server||i,a(e,n)),o.change((()=>{t=o.val(),a(e,n)}))}}}(jQuery,RED);</script>
<script type="text/javascript">var ifState=function(e){let t;return{init:function(a,n,s){t=e(a);const c=e(n),l={value:"entity",label:"entity."},r=["str","num","bool","re","jsonata","msg","flow","global",l];"currentState"!==s&&r.splice(5,1),t.after(' <a id="clearIfState" class="editor-button"><i class="fa fa-remove"></i></a>');const o=e("#clearIfState");t.typedInput({default:"str",types:r,typeField:"#node-input-halt_if_type"}),c.on("change",(e=>{let a=r,n=["flow","global",l];switch(r.includes("msg")&&(n=["msg",...n]),e.target.value){case"is":case"is_not":break;case"lt":case"lte":case"gt":case"gte":a=["num","jsonata",...n];break;case"includes":case"does_not_include":a=["str","jsonata",...n];break;case"jsonata":a=["jsonata"]}t.typedInput("types",a)})),c.trigger("change"),t.on("change",(e=>{e.currentTarget.value&&o.show()})),o.on("click",(a=>{t.typedInput("type","str"),t.typedInput("value",""),e(a.currentTarget).hide()})),t.val()||o.hide()}}}(jQuery);</script>
<script type="text/javascript">var nodeVersion=function(e){return{check:function(t){t.version=void 0===t.version?0:Number(t.version);const r=`<div id="version-update" class="ui-state-error ha-alert-box"><p><strong>Alert:</strong>This node will be updated to version ${t._def.defaults.version.value} from ${t.version} (<a href="${function(e){let t="";switch(e){case"api-current-state":t="current-state";break;case"api-call-service":t="call-service";break;case"poll-state":t="poll-state";break;case"server-state-changed":t="events-state"}return`https://zachowj.github.io/node-red-contrib-home-assistant-websocket/node/${t}.html#changelog`}(t.type)}#version" target="_blank" rel="noreferrer">changes</a>)</p></div>`;t.version<t._def.defaults.version.value&&e("#dialog-form").prepend(r)},ifStateLabels:function(e){if(this.halt_if||this.haltifstate){if(0===Number(this.version)||void 0===this.version){if(0===e)return"'If State' is false";if(1===e)return"'If State' is true"}if(0===e)return"'If State' is true";if(1===e)return"'If State' is false"}},labelStyle:function(){return`${this._def.defaults.version&&Number(this.version)!==this._def.defaults.version.value?"ha-node-label-legacy ":""}${this.name?"node_label_italic":""}`},update:function(t){t.version<t._def.defaults.version.value&&e("#node-input-version").val(t._def.defaults.version.value)}}}(jQuery);</script>
<script type="text/javascript">RED.nodes.registerType("api-call-service",{category:"home_assistant",color:"#46B1EF",inputs:1,outputs:1,icon:"ha-call-service.svg",align:"right",paletteLabel:"call service",label:function(){return this.name||`svc: ${this.service_domain}:${this.service}`},labelStyle:nodeVersion.labelStyle,defaults:{name:{value:""},server:{value:"",type:"server",required:!0},version:{value:1},debugenabled:{value:!1},service_domain:{value:""},service:{value:""},entityId:{value:""},data:{value:""},dataType:{value:"jsonata"},mergecontext:{value:null},output_location:{value:"payload"},output_location_type:{value:"none"},mustacheAltTags:{value:!1}},oneditprepare:function(){nodeVersion.check(this);const e=this,t=$("#service_domain"),i=$("#service"),n=$("#node-input-entityId"),a=$("#node-input-data"),s=$("#node-input-dataType"),o=$("#service-data-desc"),c=$(".service-description",o),l=$("tbody",o),r=$(".unknown-service",o),d=$(".known-service",o),u=$("#example-data");if(t.val(e.service_domain),i.val(e.service),!e.version)try{const t=JSON.parse(e.data);t.entity_id&&(n.val(t.entity_id),delete t.entity_id,a.val(Object.keys(t).length?JSON.stringify(t):""))}catch(e){}function v({event:t,serviceText:i}){let n=i;if(!n&&t&&(n=$(t.target).val()),n)if(e.selectedService=e.selectedDomain.services[n],e.selectedService){const t=e.selectedService.description?e.selectedService.description:"No description provided by home assistant",i=e.selectedService.fields;let a=Object.keys(i).reduce(((e,t)=>{const n=i[t];return n.description||n.example?(e.push(`<tr><td><code>${t}</code></td><td>${i[t].description||""}</td><td>${i[t].example||""}</td></tr>`),e):e}),[]);a=a.length>0?a.join(""):"",c.html(t),$("#service-data-desc .title").html(e.selectedDomain.name+"."+n),a?($("#service-data-table").show(),u.show(),l.html(a)):($("#service-data-table").hide(),u.hide(),c.append("<p>No fields documented by home-assistant<p>")),r.hide(),d.show()}else r.show(),d.hide(),u.hide(),$("#service-data-desc .title").val("");else r.show(),d.hide(),u.hide(),$("#service-data-desc .title").val("")}function p({event:t,domainText:n}){let a=n;!a&&t&&(a=$(t.target).val());const s=e.allDomains.indexOf(a)>-1;e.selectedDomain=s?{services:e.allServices[a],name:a}:e.selectedDomain={services:{}},i.autocomplete({source:Object.keys(e.selectedDomain.services).sort(),create:(e,t)=>v({event:e}),change:(e,t)=>v({event:e}),select:(e,t)=>v({event:e}),focus:(e,t)=>v({event:e}),minLength:0}).focus((function(){i.autocomplete("search")}))}a.typedInput({types:["json","jsonata"],typeField:"#node-input-dataType"}),a.on("change",(function(){$("#mustacheAltTags").toggle("json"===s.val())})),haServer.init(e,"#node-input-server"),haServer.autocomplete("entities",(t=>{function i(e){return e.split(/,\s*/)}e.availableEntities=t,n.on("keydown",(function(e){e.keyCode===$.ui.keyCode.TAB&&$(this).autocomplete().data("uiAutocomplete").menu.active&&e.preventDefault()})).autocomplete({minLength:0,source:function(t,n){n($.ui.autocomplete.filter(e.availableEntities,i(t.term).pop()))},focus:function(){return!1},select:function(e,t){const n=i(this.value);return n.pop(),n.push(t.item.value),n.push(""),this.value=n.join(", "),!1}})})),haServer.autocomplete("services",(i=>(e.allServices=i,e.allDomains=Object.keys(e.allServices).sort(),t.autocomplete({source:e.allDomains,create:(e,t)=>p({event:e}),change:(e,t)=>p({event:e}),select:(e,t)=>p({event:e}),minLength:0}).focus((function(){t.autocomplete("search")})),p({domainText:e.service_domain||""}),v({serviceText:e.service||""}),e))),this.output_location||$("#node-input-output_location").val("payload"),$("#node-input-output_location").typedInput({types:["msg","flow","global",{value:"none",label:"None",hasValue:!1}],typeField:"#node-input-output_location_type"}),u.on("click",(()=>{const t=e.selectedService.fields,i=Object.keys(t).reduce(((e,i)=>{const a=t[i].example;if("entity_id"===i)return n.val(a),e;if("["===a[0]&&"]"===a[a.length-1])try{e[i]=JSON.parse(a)}catch(e){}else isNaN(a)?'"'===a[0]&&'"'===a[a.length-1]?e[i]=a.substring(1,a.length-1):e[i]=a:e[i]=Number(a);return e}),{});Object.keys(i).length&&a.typedInput("value",JSON.stringify(i))}))},oneditsave:function(){const e=$("#node-input-entityId").val();this.service_domain=$("#service_domain").val(),this.service=$("#service").val(),e.length&&$("#node-input-entityId").val(e.replace(/\s*,\s*$/,"")),nodeVersion.update(this)}});</script>
<script type="text/x-red" data-template-name="api-call-service"><input type="hidden" id="node-input-version"><div class="form-row"><label for="node-input-name"><i class="fa fa-tag"></i> Name</label> <input type="text" id="node-input-name" placeholder="Name"></div><div class="form-row"><label for="node-input-server"><i class="fa fa-dot-circle-o"></i> Server</label> <input type="text" id="node-input-server"></div><div class="form-row"><label for="service_domain"><i class="fa fa-cube"></i> Domain</label> <input type="text" id="service_domain"></div><div class="form-row"><label for="service"><i class="fa fa-cube"></i> Service</label> <input type="text" id="service"></div><div class="form-row"><label for="node-input-entityId"><i class="fa fa-cube"></i> Entity Id</label> <input type="text" id="node-input-entityId"></div><div class="form-row"><label for="node-input-data"><i class="fa fa-dot-circle-o"></i> Data</label> <input type="text" id="node-input-data" style="width:70%"> <input type="hidden" id="node-input-dataType"></div><div class="form-row checkbox-option" id="mustacheAltTags"><input type="checkbox" id="node-input-mustacheAltTags">&nbsp; <label for="node-input-mustacheAltTags">Use alternative template tags for the Data field</label></div><div class="form-row"><label for="node-input-mergecontext">Merge Context</label> <input type="text" id="node-input-mergecontext" placeholder="lightOptions"></div><div class="form-row output-option" id="output_location"><label for="node-input-output_location">Output Location</label> <input type="hidden" id="node-input-output_location_type"> <input type="text" id="node-input-output_location" style="width:70%"></div><div id="service-data-desc" class="form-row"><button id="example-data" style="float:right;font-size:.8em">Load Example Data</button><h4>Service: <span class="title"></span></h4><div class="unknown-service">Unknown Service</div><div class="known-service"><p class="service-description"></p><table id="service-data-table" class="red-ui-info-table"><thead><tr><th>Property</th><th>Desc</th><th>Example</th></tr></thead><tbody></tbody></table></div></div><div class="form-row checkbox-option"><input type="checkbox" id="node-input-debugenabled"> <label for="node-input-debugenabled">Show Debug Information</label></div></script>
<script type="text/x-red" data-help-name="api-call-service"><p>Sends a request to home assistant for any domain and service available (<code>light/turn_on</code>, <code>input_select/select_option</code>, etc..)</p><div class="custom-block tip"><p class="custom-block-title">Helpful Examples</p><p><a href="https://zachowj.github.io/node-red-contrib-home-assistant-websocket/guide/call-service.html" rel="noopener noreferrer">Call Service Tips and Tricks</a></p></div><h3>Configuration</h3><dl class="message-properties"><dt>Domain <span text="required" class="badge">required</span><span class="property-type">string</span></dt><ul><li>Accepts <a href="https://zachowj.github.io/node-red-contrib-home-assistant-websocket/guide/mustache-templates.html" rel="noopener noreferrer">Mustache Templates</a></li></ul><dd>Service domain to call</dd><dt>Service <span text="required" class="badge">required</span><span class="property-type">string</span></dt><ul><li>Accepts <a href="https://zachowj.github.io/node-red-contrib-home-assistant-websocket/guide/mustache-templates.html" rel="noopener noreferrer">Mustache Templates</a></li></ul><dd>Service service to call</dd><dt>Entity Id<span class="property-type">string</span></dt><ul><li>Accepts <a href="https://zachowj.github.io/node-red-contrib-home-assistant-websocket/guide/mustache-templates.html" rel="noopener noreferrer">Mustache Templates</a></li></ul><dd>A comma-delimited list of entity ids.</dd><div class="custom-block tip"><p class="custom-block-title">NOTICE</p><p>If <code>entity_id</code> exists in the data property it will have precedence over this value.</p></div><dt>Data<span class="property-type">JSONata | JSON</span></dt><ul><li>Accepts <a href="https://zachowj.github.io/node-red-contrib-home-assistant-websocket/guide/mustache-templates.html" rel="noopener noreferrer">Mustache Templates</a> when data type is JSON</li></ul><dd>JSON object to pass along.</dd><dt>Merge Context<span class="property-type">string</span></dt><dd>If defined will attempt to merge the global and flow context variable into the config</dd><dt>Alternative Template Tags<span class="property-type">boolean</span></dt><dd>Will change the tags used for mustache template to <code>&lt;%</code> and <code>%&gt;</code></dd><dt>Output Location<span class="property-type">string</span></dt><ul><li>Default: <code>None</code></li></ul><dd>Customizable location for the output of the node.</dd></dl><h3>Input</h3><dl class="message-properties"><dd>All properties need to be under <code>msg.payload</code>.</dd><h5>Merging</h5><dd>If the incoming message has a <code>payload</code> property with <code>domain</code>, <code>service</code> set it will override any config values if set.</dd><dd>If the incoming message has a <code>payload.data</code> that is an object or parsable into an object these properties will be <strong>merged</strong> with any config values set.</dd><dd>If the node has a property value in its config for <code>Merge Context</code> then the <code>flow</code> and <code>global</code> contexts will be checked for this property which should be an object that will also be merged into the data payload.</dd><h5>Merge Resolution</h5><dd>As seen above the <code>data</code> property has a lot going on in the way of data merging, in the end, all of these are optional and the rightmost will win if a property exists in multiple objects</dd><dd>Config Data, Global Data, Flow Data, Payload Data ( payload data property always wins if provided</dd><dt>domain<span class="property-type">string</span></dt><dd>Service domain to call</dd><dt>service<span class="property-type">string</span></dt><dd>Service service to call</dd><dt>data<span class="property-type">Object</span></dt><dd>Service data to send with API call</dd></dl><h3>Output</h3><dl class="message-properties"><dd>All properties will be under what is defined in <code>Output Location</code> in the config.</dd><dt>domain<span class="property-type">string</span></dt><dd>Service <code>domain</code> service was called with</dd><dt>service<span class="property-type">string</span></dt><dd>Service <code>service</code> was called with</dd><dt>data<span class="property-type">Object</span></dt><dd>Service <code>data</code> used in a call, if one was used</dd><h5>Example of output:</h5><pre><code class="language-json">{
  &quot;domain&quot;: &quot;light&quot;,
  &quot;service&quot;: &quot;turn_on&quot;,
  &quot;data&quot;: {
    &quot;entity_id&quot;: &quot;light.kitchen&quot;
  }
}
</code></pre></dl></script>
<style>#version-update{padding:.5em;margin-bottom:1em}#version-update p{margin:0}#version-update strong{padding-right:5px}#version-update a,#version-update a:hover{color:#555}.form-row.checkbox-option input{margin-left:105px;margin-right:5px;display:inline-block;width:auto;vertical-align:top}.form-row.checkbox-option label{width:auto}.form-row.checkbox-option-left input{display:inline-block;margin-right:5px;width:auto;vertical-align:top}.form-row.checkbox-option-left label{width:auto;margin-right:20px}.editable-list-row{margin-bottom:4px}#constraint-list{min-width:446px}#constraint-list input{width:65%}#output-list input{width:62%}#clearIfState{position:absolute;margin-left:2px}.ha-node-label-legacy{fill:#fdfd96;stroke-width:0;font-size:14px;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}li span.property-type{font-family:Helvetica Neue,Arial,Helvetica,sans-serif;color:#666;font-style:italic;font-size:11px;float:right}.ha-alert-box{padding:10px;margin-bottom:10px}.custom-block .custom-block-title{font-weight:600}.custom-block.danger,.custom-block.tip,.custom-block.warning{padding:.1rem 1.5rem;border-left-width:.5rem;border-left-style:solid;margin:1rem 0}.custom-block.tip{background-color:#f3f5f7;border-color:#42b983;color:#2c3e50}.custom-block.tip a{color:#3eaf7c}.custom-block.warning{background-color:#fff6c6;border-color:#e7c000;color:#6b5900}.custom-block.warning .custom-block-title{color:#b29400}.custom-block.warning a{color:#2c3e50}.custom-block.danger{background-color:#ffe6e6;border-color:#c00;color:#4d0000}.custom-block.danger .custom-block-title{color:#900}.custom-block.danger a{color:#2c3e50}.button-box div.text-box{display:inline-block;position:relative;width:70%;height:20px}.button-box div.text-box div{position:absolute;left:0;right:40px}.button-box div.text-box div input{width:100%}.button-box div.text-box a{position:absolute;right:0;top:0}.badge{display:inline-block;font-size:12px;height:16px;line-height:16px;border-radius:3px;padding:0 6px;color:#fff}.badge,.badge.green,.badge.tip{background-color:#42b983}.badge.error{background-color:#da5961}.badge.warn,.badge.warning,.badge.yellow{background-color:#e7c000}.badge+.badge{margin-left:5px}</style>